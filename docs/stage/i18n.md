# Stage Plan: i18n End-to-End
**Focus**: `i18n`
**Status**: READY FOR ROLLOUT

## Context
- i18n must apply from landing language choice to dashboard + transactional emails.
- Default language selected at first entry should persist and be used everywhere.

## Goals
- Persist user locale (unauth + auth) and apply globally (UI + API + emails).
- Ensure email templates render in selected locale.
- Add fallback strategy and missing-key handling.
- Verification plan covering landing → wizard → delivery email.

## Non-Goals
- No redesign.
- No new languages beyond existing baseline (start with ES/EN unless repo differs).

## Checklist
- [x] Define locale source-of-truth + persistence (cookie/localStorage/profile).
- [x] Middleware / routing strategy for locale (App Router).
- [x] Dashboard + wizard strings migrated to translation files.
- [x] Emails: subject/body localized; locale passed to send pipeline.
- [x] QA matrix (ES/EN) + build checks.

## Implemented (as of 2026-02-19)
- **Locale source of truth**: `profiles.locale` for authenticated users; `vfl_locale` cookie for anonymous sessions and SSR consistency.
- **Sync behavior**: Middleware ensures locale persistence; logout clears session but preserves locale preference via cookie.
- **Landing localized**: Full home page supporting dynamic content switch.
- **Wizard localized**: Entire message creation flow (audio/video recorder, trusted contacts, delivery rules, and final review) uses dictionary keys.
- **Transactional emails**: Localized subject lines and bodies; centralized templates using `getDictionary`.
- **Debug email endpoint**: Secured via `NODE_ENV` production block and `DEBUG_EMAIL_TOKEN`.
- **Quality Assurance**: Added dictionary smoke test (commit `07ddf27`) to ensure key parity between `messages/en.json` and `messages/es.json`.

## Production rollout
- Verify `/en` and `/es` landing + wizard end-to-end.
- Verify login/logout preserves locale.
- Verify transactional emails render correct locale (spot-check via debug endpoint in staging).
- Ensure debug endpoint is unreachable in production.
- `npm run build` passes in CI.

## Risks & Mitigations
- Drift between UI and emails → centralized `lib/email-templates.ts` using the same dictionaries.
- Partial translations → `lib/i18n/dictionary.smoke.test.ts` identifies missing keys during test phase.

## Verification Plan
- Fresh visitor selects ES → entire flow stays ES.
- Same user selects EN → persists after login/logout.
- Email sent in correct locale.
- `npm run build` passes.
